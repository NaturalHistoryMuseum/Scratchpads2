/*! wavesurfer.js 1.4.0 (Tue, 09 Oct 2018 15:21:58 GMT)
* https://github.com/katspaugh/wavesurfer.js
* @license BSD-3-Clause */
!function(e,t){void 0===e&&void 0!==window&&(e=window),"function"==typeof define&&define.amd?define(["wavesurfer"],function(e){return t(e)}):"object"==typeof module&&module.exports?module.exports=t(require("wavesurfer.js")):t(e.WaveSurfer)}(this,function(w){"use strict";w.Spectrogram={init:function(e){this.params=e;var t=this.wavesurfer=e.wavesurfer;if(!this.wavesurfer)throw Error("No WaveSurfer instance provided");this.frequenciesDataUrl=e.frequenciesDataUrl;var a=this.drawer=this.wavesurfer.drawer;if(this.container="string"==typeof e.container?document.querySelector(e.container):e.container,!this.container)throw Error("No container for WaveSurfer spectrogram");this.width=a.width,this.pixelRatio=this.params.pixelRatio||t.params.pixelRatio,this.fftSamples=this.params.fftSamples||t.params.fftSamples||512,this.height=this.fftSamples/2,this.noverlap=e.noverlap,this.windowFunc=e.windowFunc,this.alpha=e.alpha,this.createWrapper(),this.createCanvas(),this.render(),a.wrapper.addEventListener("scroll",function(e){this.updateScroll(e)}.bind(this)),t.on("redraw",this.render.bind(this)),t.on("destroy",this.destroy.bind(this))},destroy:function(){this.unAll(),this.wrapper&&(this.wrapper.parentNode.removeChild(this.wrapper),this.wrapper=null)},createWrapper:function(){var e=this.container.querySelector("spectrogram");if(e&&this.container.removeChild(e),this.params.labels){var t=document.createElement("div");t.setAttribute("id","specLabels"),this.drawer.style(t,{left:0,position:"relative",zIndex:9}),t.innerHTML="<canvas></canvas>",this.wrapper=this.container.appendChild(t),this.loadLabels("rgba(68,68,68,0.5)","12px","10px","","#fff","#f7f7f7","center","#specLabels")}var a=this.wavesurfer.params,r=document.createElement("spectrogram");this.params.labels&&this.drawer.style(r,{left:0,position:"relative"}),this.wrapper=this.container.appendChild(r),this.drawer.style(this.wrapper,{display:"block",position:"relative",userSelect:"none",webkitUserSelect:"none",height:this.height+"px"}),(a.fillParent||a.scrollParent)&&this.drawer.style(this.wrapper,{width:"100%",overflowX:"hidden",overflowY:"hidden"});var i=this;this.wrapper.addEventListener("click",function(e){e.preventDefault();var t="offsetX"in e?e.offsetX:e.layerX;i.fireEvent("click",t/i.scrollWidth||0)})},createCanvas:function(){var e=this.canvas=this.wrapper.appendChild(document.createElement("canvas"));this.spectrCc=e.getContext("2d"),this.wavesurfer.drawer.style(e,{position:"absolute",zIndex:4})},render:function(){this.updateCanvasStyle(),this.frequenciesDataUrl?this.loadFrequenciesData(this.frequenciesDataUrl):this.getFrequencies(this.drawSpectrogram)},updateCanvasStyle:function(){var e=Math.round(this.width/this.pixelRatio)+"px";this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.style.width=e},drawSpectrogram:function(e,t){t.spectrCc,t.wavesurfer.backend.getDuration();for(var a=t.height,r=t.resample(e),i=t.buffer?2/t.buffer.numberOfChannels:1,s=0;s<r.length;s++)for(var n=0;n<r[s].length;n++){var h=255-r[s][n];t.spectrCc.fillStyle="rgb("+h+", "+h+", "+h+")",t.spectrCc.fillRect(s,a-n*i,1,i)}},getFrequencies:function(e){var t=this.fftSamples,a=this.buffer=this.wavesurfer.backend.buffer,r=a.getChannelData(0),i=a.length,s=a.sampleRate,n=[];if(a){var h=this.noverlap;if(!h){var o=a.length/this.canvas.width;h=Math.max(0,Math.round(t-o))}for(var l=new w.FFT(t,s,this.windowFunc,this.alpha),f=(Math.floor(i/(t-h)),0);f+t<r.length;){for(var c=r.slice(f,f+t),u=l.calculateSpectrum(c),p=new Uint8Array(t/2),d=0;d<t/2;d++)p[d]=Math.max(-255,45*Math.log10(u[d]));n.push(p),f+=t-h}e(n,this)}else this.fireEvent("error","Web Audio buffer is not available")},loadFrequenciesData:function(e){var t=this,a=w.util.ajax({url:e});return a.on("success",function(e){t.drawSpectrogram(JSON.parse(e),t)}),a.on("error",function(e){t.fireEvent("error","XHR error: "+e.target.statusText)}),a},freqType:function(e){return 1e3<=e?(e/1e3).toFixed(1):Math.round(e)},unitType:function(e){return 1e3<=e?"KHz":"Hz"},loadLabels:function(e,t,a,r,i,s,n,h){e=e||"rgba(68,68,68,0.5)",t=t||"12px",a=a||"10px",r=r||"Helvetica",i=i||"#fff",s=s||"#fff",n=n||"center",h=h||"#specLabels";var o=this.height||512,l=o/256*5,f=(this.wavesurfer.backend.ac.sampleRate/2-0)/l,c=document.querySelectorAll(h+" canvas")[0].getContext("2d");document.querySelectorAll(h+" canvas")[0].height=this.height,document.querySelectorAll(h+" canvas")[0].width=55,c.fillStyle=e,c.fillRect(0,0,55,o),c.fill();for(var u=0;u<=l;u++){c.textAlign=n,c.textBaseline="middle";var p=0+f*u,d=(Math.round(p/this.sampleRate/2*this.fftSamples),Math.round(p/(this.fftSamples/2)*this.fftSamples),this.fftSamples,this.height,this.freqType(p)),w=this.unitType(p);0==u?(c.fillStyle=s,c.font=a+" "+r,c.fillText(w,40,o+u-10),c.fillStyle=i,c.font=t+" "+r,c.fillText(d,16,o+u-10)):(c.fillStyle=s,c.font=a+" "+r,c.fillText(w,40,o-50*u+2),c.fillStyle=i,c.font=t+" "+r,c.fillText(d,16,o-50*u+2))}},updateScroll:function(e){this.wrapper.scrollLeft=e.target.scrollLeft},resample:function(e,t){t=this.width;for(var a=[],r=1/e.length,i=1/t,s=0;s<t;s++){for(var n=new Array(e[0].length),h=0;h<e.length;h++){var o=h*r,l=o+r,f=s*i,c=f+i,u=l<=f||c<=o?0:Math.min(Math.max(l,f),Math.max(c,o))-Math.max(Math.min(l,f),Math.min(c,o));if(0<u)for(var p=0;p<e[0].length;p++)null==n[p]&&(n[p]=0),n[p]+=u/i*e[h][p]}var d=new Uint8Array(e[0].length);for(p=0;p<e[0].length;p++)d[p]=n[p];a.push(d)}return a}},w.FFT=function(e,t,a,r){switch(this.bufferSize=e,this.sampleRate=t,this.bandwidth=2/e*t/2,this.sinTable=new Float32Array(e),this.cosTable=new Float32Array(e),this.windowValues=new Float32Array(e),this.reverseTable=new Uint32Array(e),this.peakBand=0,this.peak=0,a){case"bartlett":for(var i=0;i<e;i++)this.windowValues[i]=2/(e-1)*((e-1)/2-Math.abs(i-(e-1)/2));break;case"bartlettHann":for(i=0;i<e;i++)this.windowValues[i]=.62-.48*Math.abs(i/(e-1)-.5)-.38*Math.cos(2*Math.PI*i/(e-1));break;case"blackman":r=r||.16;for(i=0;i<e;i++)this.windowValues[i]=(1-r)/2-.5*Math.cos(2*Math.PI*i/(e-1))+r/2*Math.cos(4*Math.PI*i/(e-1));break;case"cosine":for(i=0;i<e;i++)this.windowValues[i]=Math.cos(Math.PI*i/(e-1)-Math.PI/2);break;case"gauss":r=r||.25;for(i=0;i<e;i++)this.windowValues[i]=Math.pow(Math.E,-.5*Math.pow((i-(e-1)/2)/(r*(e-1)/2),2));break;case"hamming":for(i=0;i<e;i++)this.windowValues[i]=.54-.46*Math.cos(2*Math.PI*i/(e-1));break;case"hann":case void 0:for(i=0;i<e;i++)this.windowValues[i]=.5*(1-Math.cos(2*Math.PI*i/(e-1)));break;case"lanczoz":for(i=0;i<e;i++)this.windowValues[i]=Math.sin(Math.PI*(2*i/(e-1)-1))/(Math.PI*(2*i/(e-1)-1));break;case"rectangular":for(i=0;i<e;i++)this.windowValues[i]=1;break;case"triangular":for(i=0;i<e;i++)this.windowValues[i]=2/e*(e/2-Math.abs(i-(e-1)/2));break;default:throw Error("No such window function '"+a+"'")}for(var s=1,n=e>>1;s<e;){for(i=0;i<s;i++)this.reverseTable[i+s]=this.reverseTable[i]+n;s<<=1,n>>=1}for(i=0;i<e;i++)this.sinTable[i]=Math.sin(-Math.PI/i),this.cosTable[i]=Math.cos(-Math.PI/i);this.calculateSpectrum=function(e){var t,a,r,i=this.bufferSize,s=this.cosTable,n=this.sinTable,h=this.reverseTable,o=new Float32Array(i),l=new Float32Array(i),f=2/this.bufferSize,c=Math.sqrt,u=new Float32Array(i/2),p=Math.floor(Math.log(i)/Math.LN2);if(Math.pow(2,p)!==i)throw"Invalid buffer size, must be a power of 2.";if(i!==e.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+i+" Buffer Size: "+e.length;for(var d,w,v,m,b,g,M,S,y=1,x=0;x<i;x++)o[x]=e[h[x]]*this.windowValues[h[x]],l[x]=0;for(;y<i;){d=s[y],w=n[y],v=1;for(var T=m=0;T<y;T++){for(x=T;x<i;)g=v*o[b=x+y]-m*l[b],M=v*l[b]+m*o[b],o[b]=o[x]-g,l[b]=l[x]-M,o[x]+=g,l[x]+=M,x+=y<<1;v=(S=v)*d-m*w,m=S*w+m*d}y<<=1}x=0;for(var F=i/2;x<F;x++)(r=f*c((t=o[x])*t+(a=l[x])*a))>this.peak&&(this.peakBand=x,this.peak=r),u[x]=r;return u}},w.util.extend(w.Spectrogram,w.Observer,w.FFT)});