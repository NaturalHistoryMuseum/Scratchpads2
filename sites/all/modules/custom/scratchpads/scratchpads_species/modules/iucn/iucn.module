<?php

//require 'sites/all/libraries/vendor/autoload.php';
require 'sites/all/libraries/jbroutier/iucn-api-client/src/Client.php';


/**
 * Implements hook_init().
 */
function iucn_init() {
  // Support Libraries API - http://drupal.org/project/libraries
  $iucnapiclient_path = libraries_get_path('iucn-api-client');
  $iucnapiclient_path = ($iucnapiclient_path ? $iucnapiclient_path . '/src/' : '');

  // Include FirePHP if it exists.
  if (!empty($iucnapiclient_path) && file_exists($iucnapiclient_path . 'Client.php')) {
    include_once $iucnapiclient_path . 'ClientInterface.php';
    include_once $iucnapiclient_path . 'Client.php';
  }
}


/**
 * Implements hook_block_info().
 */
function iucn_block_info(){
  return array(
    'default' => array(
      'info' => t('IUCN Species Page Block'),
      'cache' => DRUPAL_CACHE_PER_PAGE,
      'pages' => 'taxonomy/term/*/descriptions',
      'visibility' => BLOCK_VISIBILITY_LISTED,
      'status' => 1,
      'region' => 'content',
      'weight' => 101
    )
  );
}

/**
 * Implements hook_flush_caches()
 */
function iucn_flush_caches(){
  if(function_exists('varnish_purge')){
    varnish_purge(_varnish_get_host(), 'ajaxblocks');
  }
  return array(
    'cache_iucn'
  );
}

/**
 * Implements hook_block_view().
 */
function iucn_block_view($delta = ''){
  $content = array(
    'subject' => t('IUCN'),
    'content' => array(
      '#attached' => array(
        'css' => array(
          drupal_get_path('module', 'iucn') . '/css/iucn.css'
        )
      ),
      '#markup' => '<p>' . t('Unable to fetch data from IUCN.') . '</p>'
    )
  );
  // We load the term from the menu
  $term = menu_get_object('taxonomy_term', 2);
  if($term){

    $iucnV3APIKeyToken = variable_get('iucn_api_v3_api_key_token', FALSE);
    $iucnV3Url = variable_get('iucn_api_v3_url', FALSE);

    $iucnClient = new \IucnApi\Client($iucnV3APIKeyToken);
    
    // simplifid logic:
    $flagAjaxBlocks = false; //initial default
    // was:
    //if(!function_exists('ajaxblocks_in_ajax_handler') || (function_exists('ajaxblocks_in_ajax_handler') && ajaxblocks_in_ajax_handler())){
    // no comment about what this is exactly supposed to do, so breaking it down into several IFs 
    if (!function_exists('ajaxblocks_in_ajax_handler')) {
      $flagAjaxBlocks = true;
    } else { 
      if (function_exists('ajaxblocks_in_ajax_handler') && ajaxblocks_in_ajax_handler()) {
        $flagAjaxBlocks = true;
      }
    }

    if($flagAjaxBlocks){
      $cache = cache_get($term->tid, 'cache_iucn');
      if($cache->data){
        $content['content']['#markup'] = $cache->data;
      }else{

        try {
          $aterm = $term->name;
          $species = $iucnClient->getSpeciesByName($term->name);

          $contentMarkupToDisplay ="";

          // https://stackoverflow.com/questions/9744192/multi-line-strings-in-php
          $contentMarkupToDisplay = <<<EOD
<style>
  .iucn-item.name {
    background-color: #eeeeee;
    font-weight: bold;
  }

  .iucn-item.value {
    background-color: white;
  }

  .iucn-item {
    padding: 5px;
  }
</style>
EOD;
          
          // bad advice here: https://stackoverflow.com/questions/15700325/
          // so I used this: https://stackoverflow.com/a/5970283/227926
          foreach((array)$species as $key => $value) {
            // https://stackoverflow.com/questions/41243543/what-does-an-array-with-a-mean/41243650#41243650
            // https://stackoverflow.com/a/41243650/227926
            $keyWithoutAsteriskPrefix = preg_replace('/[\*]+/', '', $key);
            $item = "<div class='iucn-item name'>".$keyWithoutAsteriskPrefix."</div>\n";
            if (isset($value)) {
              $item .= "<div class='iucn-item value'>".$value."</div>\n";
            }
            else {
              $item .= "<div>-</div>\n";
            }

            $contentMarkupToDisplay .= $item;
          }


          $content['content']['#markup'] = $contentMarkupToDisplay;

          cache_set($term->tid, $content['content']['#markup'], 'cache_iucn');

        } catch (\IucnApi\Exception\IucnApiException $exception) {
          // Something doesn't look goodâ€¦
          $content['content']['#markup'] = t('There was an error downloading the information for %term_name', array(
            '$term_name' => $term->name
          ));
        }
      }
    }
  }
  return $content;
}

/**
 * Implements hook_form_FORM_ID_alter()
 */
function iucn_form_block_admin_configure_alter(&$form, &$form_state, $form_id){
  if($form['module']['#value'] == 'iucn'){
    // Prevent editing of this block.
    if(!user_access('scratchpad team')){
      drupal_set_message(t('You may not edit the IUCN block'));
      drupal_goto();
    }
  }
}

/**
 * Implements hook_contextual_links_view_alter().
 */
function iucn_contextual_links_view_alter(&$element, $items){
  if(@isset($element['#contextual_links']['block'][1][0]) && $element['#contextual_links']['block'][1][0] == 'iucn' && !user_access('scratchpad team')){
    $element = array();
  }
}